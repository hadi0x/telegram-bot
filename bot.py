import os
import requests
import time
import telebot

# âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
VIRUSTOTAL_API_KEY = os.getenv("VIRUSTOTAL_API_KEY")
VIRUSTOTAL_URL = "https://www.virustotal.com/api/v3/urls"

# âœ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª Ù…Ø­Ù…Ù„Ø©
if not TOKEN:
    raise ValueError("âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ `TELEGRAM_BOT_TOKEN` ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©! ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØªÙ‡ ÙÙŠ `Railway`.")
if not VIRUSTOTAL_API_KEY:
    raise ValueError("âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ `VIRUSTOTAL_API_KEY` ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©! ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØªÙ‡ ÙÙŠ `Railway`.")

# ğŸ”¹ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙˆØª
bot = telebot.TeleBot(TOKEN)

# âœ… Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª
@bot.message_handler(commands=['start'])
def start(message):
    bot.reply_to(message, "âœ… Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ! Ø£Ø±Ø³Ù„ Ù„ÙŠ Ø±Ø§Ø¨Ø·Ù‹Ø§ ÙˆØ³Ø£Ù‚ÙˆÙ… Ø¨ÙØ­ØµÙ‡ Ø¹Ø¨Ø± VirusTotal ğŸ”")

@bot.message_handler(func=lambda message: message.text.startswith("http"))
def scan_url(message):
    url_to_scan = message.text
    headers = {"x-apikey": VIRUSTOTAL_API_KEY}
    data = {"url": url_to_scan}

    try:
        response = requests.post(VIRUSTOTAL_URL, headers=headers, data=data)
        response_json = response.json()  # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø¯ Ø¥Ù„Ù‰ JSON
        
        # âœ… Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„ÙØ­Øµ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
        print("ğŸ” Ø§Ø³ØªØ¬Ø§Ø¨Ø© API Ø§Ù„ÙƒØ§Ù…Ù„Ø©:", response_json)

        if response.status_code == 200 and "data" in response_json:
            scan_id = response_json["data"]["id"]
            analysis_url = f"https://www.virustotal.com/api/v3/analyses/{scan_id}"
            
            # âœ… Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„ÙØªØ±Ø© Ù‚ØµÙŠØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            time.sleep(5)
            
            # ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„
            analysis_response = requests.get(analysis_url, headers=headers)
            analysis_json = analysis_response.json()
            
            # âœ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ `attributes`
            if "data" in analysis_json and "attributes" in analysis_json["data"]:
                positives = analysis_json["data"]["attributes"]["stats"]["malicious"]

                if positives == 0:
                    status = "âœ… Ø§Ù„Ø±Ø§Ø¨Ø· Ø¢Ù…Ù† ØªÙ…Ø§Ù…Ù‹Ø§."
                elif positives <= 3:
                    status = "âš ï¸ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø´Ø¨ÙˆÙ‡ØŒ ÙŠØ±Ø¬Ù‰ ØªÙˆØ®ÙŠ Ø§Ù„Ø­Ø°Ø±."
                else:
                    status = "âŒ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ø­ØªÙŠØ§Ù„ÙŠ Ø£Ùˆ Ø¶Ø§Ø±ØŒ Ù„Ø§ ØªÙ‚Ù… Ø¨ÙØªØ­Ù‡!"

                bot.reply_to(message, f"{status}\nğŸ”— [Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù„ÙŠÙ„](https://www.virustotal.com/gui/url/{scan_id})")
            else:
                bot.reply_to(message, f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„. Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ 'attributes'.\nğŸ“Œ Ø§Ù„Ø±Ø¯: {analysis_json}")

        else:
            bot.reply_to(message, f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ VirusTotal API: {response.status_code}\nğŸ“Œ Ø§Ù„Ø±Ø¯: {response_json}")

    except Exception as e:
        bot.reply_to(message, f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙØ­Øµ:\n{str(e)}")

# ğŸ”¹ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
print("ğŸš€ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†...")
bot.polling()
